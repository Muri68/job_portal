{% extends "job/base.html" %}
{% load static %}

{% block title %}{{ application.applicant_name }} - Application Details - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-12">
            <!-- Header Section -->
            <header class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-3">
                <div class="flex-grow-1">
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="{% url 'admin-dashboard' %}" class="text-primary text-decoration-none">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'applicants_list' %}" class="text-primary text-decoration-none">Applicants</a></li>
                            <li class="breadcrumb-item active text-secondary">{{ application.applicant_name }}</li>
                        </ol>
                    </nav>
                    
                    <div class="d-flex align-items-center flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <img src="https://ui-avatars.com/api/?name={{ application.applicant_name|urlencode }}&background=257dd4&color=fff&size=100" 
                                 alt="{{ application.applicant_name }}" 
                                 class="applicant-avatar me-3">
                            <div>
                                <h1 class="h3 fw-bold text-dark mb-1">{{ application.applicant_name }}</h1>
                                <p class="text-secondary mb-0">Applied for <strong class="text-primary">{{ application.job.title }}</strong></p>
                            </div>
                        </div>
                        
                        <div class="ms-auto">
                            <span class="badge fs-6 px-3 py-2 
                                {% if application.status == 'pending' %}bg-warning
                                {% elif application.status == 'reviewed' %}bg-info
                                {% elif application.status == 'accepted' %}bg-success
                                {% else %}bg-danger{% endif %}">
                                <i class="bi bi-circle-fill me-1" style="font-size: 0.6em;"></i>
                                {{ application.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 flex-shrink-0">
                    <a href="{% url 'applicants_list' %}" class="btn btn-outline-secondary px-4">
                        <i class="bi bi-arrow-left me-2"></i>Back
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-primary px-4 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear me-2"></i>Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3">
                            <li>
                                <a href="{% url 'compose_email' application.id %}" class="dropdown-item">
                                    <i class="bi bi-envelope me-2"></i>Send Email
                                </a>
                            </li>
                            {% if application.applicant_phone %}
                            <li>
                                <a class="dropdown-item" href="tel:{{ application.applicant_phone }}">
                                    <i class="bi bi-telephone me-2"></i>Call Applicant
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </header>

            <div class="row">
                <!-- Left Column - Applicant Details -->
                <div class="col-lg-8">
                    <!-- Contact Information Card -->
                    <section class="card shadow-sm border-0 mb-4" aria-labelledby="contact-info-heading">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h2 id="contact-info-heading" class="h5 mb-0 fw-bold text-dark">
                                <i class="bi bi-person-lines-fill text-primary me-2"></i>Contact Information
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 rounded-3" style="background-color: var(--light);">
                                        <div class="rounded-circle p-2 me-3" style="background-color: var(--primary-light);">
                                            <i class="bi bi-envelope text-primary"></i>
                                        </div>
                                        <div>
                                            <small class="text-secondary d-block">Email Address</small>
                                            <a href="mailto:{{ application.applicant_email }}" class="text-dark fw-semibold text-decoration-none">
                                                {{ application.applicant_email }}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 rounded-3" style="background-color: var(--light);">
                                        <div class="rounded-circle p-2 me-3" style="background-color: var(--primary-light);">
                                            <i class="bi bi-telephone text-primary"></i>
                                        </div>
                                        <div>
                                            <small class="text-secondary d-block">Phone Number</small>
                                            <span class="text-dark fw-semibold">{{ application.applicant_phone|default:"Not provided" }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if application.linkedin_profile %}
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 rounded-3" style="background-color: var(--light);">
                                        <div class="rounded-circle p-2 me-3" style="background-color: var(--primary-light);">
                                            <i class="bi bi-linkedin text-primary"></i>
                                        </div>
                                        <div>
                                            <small class="text-secondary d-block">LinkedIn Profile</small>
                                            <a href="{{ application.linkedin_profile }}" target="_blank" class="text-dark fw-semibold text-decoration-none text-truncate d-block">
                                                View Profile
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if application.portfolio_url %}
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 rounded-3" style="background-color: var(--light);">
                                        <div class="rounded-circle p-2 me-3" style="background-color: var(--primary-light);">
                                            <i class="bi bi-globe text-primary"></i>
                                        </div>
                                        <div>
                                            <small class="text-secondary d-block">Portfolio</small>
                                            <a href="{{ application.portfolio_url }}" target="_blank" class="text-dark fw-semibold text-decoration-none text-truncate d-block">
                                                Visit Portfolio
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </section>

                    <!-- Cover Letter Card -->
                    <section class="card shadow-sm border-0 mb-4" aria-labelledby="cover-letter-heading">
                        <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                            <h2 id="cover-letter-heading" class="h5 mb-0 fw-bold text-dark">
                                <i class="bi bi-file-text text-primary me-2"></i>Cover Letter
                            </h2>
                            <span class="badge" style="background-color: var(--primary-light); color: var(--primary);">
                                {{ application.cover_letter|wordcount }} words
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="p-4 rounded-3" style="background-color: var(--light);">
                                <div class="cover-letter-content">
                                    {{ application.cover_letter|linebreaks }}
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Right Column - Actions & Information -->
                <div class="col-lg-4">
                    <!-- Status Management Card -->
                    <section class="card shadow-sm border-0 mb-4" aria-labelledby="status-heading">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h2 id="status-heading" class="h5 mb-0 fw-bold text-dark">
                                <i class="bi bi-arrow-repeat text-primary me-2"></i>Update Status
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2" id="statusButtons">
                                {% for value, label in application.STATUS_CHOICES %}
                                <button 
                                    class="btn btn-lg {% if application.status == value %}btn-primary{% else %}btn-outline-primary{% endif %} status-btn rounded-3 px-3 py-2 text-start d-flex align-items-center justify-content-between"
                                    data-status="{{ value }}"
                                    {% if application.status == value %}disabled{% endif %}
                                >
                                    <span>
                                        <i class="bi 
                                            {% if value == 'pending' %}bi-clock
                                            {% elif value == 'reviewed' %}bi-eye
                                            {% elif value == 'accepted' %}bi-check-circle
                                            {% else %}bi-x-circle{% endif %} me-2"></i>
                                        {{ label }}
                                    </span>
                                    {% if application.status == value %}
                                    <i class="bi bi-check ms-2"></i>
                                    {% endif %}
                                </button>
                                {% endfor %}
                            </div>
                            
                            <!-- Status Message -->
                            <div id="statusMessage" class="mt-3"></div>
                        </div>
                    </section>

                    <!-- Application Details Card -->
                    <section class="card shadow-sm border-0 mb-4" aria-labelledby="details-heading">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h2 id="details-heading" class="h5 mb-0 fw-bold text-dark">
                                <i class="bi bi-info-circle text-primary me-2"></i>Application Details
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item px-0 py-3 border-0 d-flex justify-content-between">
                                    <span class="text-secondary">Applied On</span>
                                    <span class="fw-semibold text-dark">{{ application.applied_at|date:"M d, Y" }}</span>
                                </div>
                                <div class="list-group-item px-0 py-3 border-0 d-flex justify-content-between">
                                    <span class="text-secondary">Applied Time</span>
                                    <span class="fw-semibold text-dark">{{ application.applied_at|date:"g:i A" }}</span>
                                </div>
                                <div class="list-group-item px-0 py-3 border-0 d-flex justify-content-between">
                                    <span class="text-secondary">Time Since</span>
                                    <span class="fw-semibold text-dark">{{ application.applied_at|timesince }} ago</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Resume Card -->
                    <section class="card shadow-sm border-0" aria-labelledby="resume-heading">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h2 id="resume-heading" class="h5 mb-0 fw-bold text-dark">
                                <i class="bi bi-file-earmark-pdf text-primary me-2"></i>Resume
                            </h2>
                        </div>
                        <div class="card-body">
                            {% if application.resume %}
                            <div class="d-grid gap-2">
                                <a href="{{ application.resume.url }}" class="btn btn-outline-primary rounded-3 py-2" target="_blank">
                                    <i class="bi bi-eye me-2"></i>View Resume
                                </a>
                                <a href="{{ application.resume.url }}" download class="btn btn-primary rounded-3 py-2">
                                    <i class="bi bi-download me-2"></i>Download Resume
                                </a>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-file-excel text-muted fs-1 mb-3 d-block"></i>
                                <p class="text-secondary mb-0">No resume uploaded</p>
                            </div>
                            {% endif %}
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary: #257dd4;
    --primary-light: #257cd491;
    --primary-dark: #257dd4;
    --secondary: #546E7A;
    --accent: #FF9800;
    --light: #E3F2FD;
    --dark: #257dd4;
    --gradient-start: #257dd4;
    --gradient-end: #257dd4;
    --sidebar-width: 280px;
}

/* Applicant avatar styling */
.applicant-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(37, 125, 212, 0.2);
}

/* Button styles using your theme */
.btn-primary {
    background-color: var(--primary);
    border-color: var(--primary);
}

.btn-primary:hover,
.btn-primary:focus {
    background-color: var(--primary-dark);
    border-color: var(--primary-dark);
}

.btn-outline-primary {
    color: var(--primary);
    border-color: var(--primary);
}

.btn-outline-primary:hover,
.btn-outline-primary:focus {
    background-color: var(--primary);
    border-color: var(--primary);
    color: white;
}

.btn-outline-secondary {
    color: var(--secondary);
    border-color: var(--secondary);
}

.btn-outline-secondary:hover,
.btn-outline-secondary:focus {
    background-color: var(--secondary);
    border-color: var(--secondary);
    color: white;
}

/* Text colors */
.text-primary {
    color: var(--primary) !important;
}

.text-secondary {
    color: var(--secondary) !important;
}

.text-dark {
    color: #2c3e50 !important;
}

/* Card styles */
.card {
    border: none;
    border-radius: 0.75rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 125, 212, 0.15) !important;
}

/* Background colors */
.bg-light {
    background-color: var(--light) !important;
}

/* Breadcrumb styling */
.breadcrumb {
    background: transparent;
    padding: 0;
}

.breadcrumb-item a {
    color: var(--primary);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

.breadcrumb-item.active {
    color: var(--secondary);
}

/* Cover letter content */
.cover-letter-content {
    line-height: 1.7;
    color: var(--secondary);
    font-size: 0.95rem;
}

.cover-letter-content p {
    margin-bottom: 1rem;
}

/* Status buttons */
.status-btn {
    transition: all 0.3s ease;
    border: 2px solid;
}

.status-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 125, 212, 0.15);
}

/* List group items */
.list-group-item {
    background: transparent;
    border-color: rgba(37, 125, 212, 0.1);
}

/* Badge styling */
.badge.bg-primary {
    background-color: var(--primary) !important;
}

/* Dropdown menu */
.dropdown-menu {
    border: 1px solid rgba(37, 125, 212, 0.1);
}

.dropdown-item:hover {
    background-color: var(--primary-light);
    color: var(--primary-dark);
}

/* Alert styling */
.alert-success {
    background-color: rgba(40, 167, 69, 0.1);
    border-color: rgba(40, 167, 69, 0.2);
    color: #155724;
}

.alert-danger {
    background-color: rgba(220, 53, 69, 0.1);
    border-color: rgba(220, 53, 69, 0.2);
    color: #721c24;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.card {
    animation: fadeIn 0.5s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .card-body {
        padding: 1.25rem;
    }
    
    .d-flex.align-items-center.flex-wrap {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .ms-auto {
        margin-left: 0 !important;
        margin-top: 1rem;
    }
    
    .applicant-avatar {
        width: 60px;
        height: 60px;
    }
    
    .btn {
        width: 100%;
    }
    
    .dropdown {
        width: 100%;
    }
    
    .dropdown-toggle {
        width: 100%;
    }
}

@media (max-width: 576px) {
    .card-body {
        padding: 1rem;
    }
    
    .applicant-avatar {
        width: 50px;
        height: 50px;
    }
    
    .h3 {
        font-size: 1.5rem;
    }
    
    .btn-lg {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const buttons = document.querySelectorAll(".status-btn");
    const statusMessage = document.getElementById("statusMessage");
    const currentStatusBadge = document.querySelector(".badge.fs-6");

    buttons.forEach(button => {
        button.addEventListener("click", function () {
            const newStatus = this.dataset.status;
            const newStatusText = this.textContent.trim();

            // Add loading state
            const originalContent = this.innerHTML;
            this.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Updating...';
            this.disabled = true;

            fetch("{% url 'update_application_status' application.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update all buttons
                    buttons.forEach(btn => {
                        btn.classList.remove("btn-primary");
                        btn.classList.add("btn-outline-primary");
                        btn.disabled = false;
                        btn.innerHTML = btn.innerHTML.replace('<i class="bi bi-check ms-2"></i>', '');
                    });
                    
                    // Update clicked button
                    this.classList.remove("btn-outline-primary");
                    this.classList.add("btn-primary");
                    this.disabled = true;
                    this.innerHTML = originalContent + '<i class="bi bi-check ms-2"></i>';
                    
                    // Update status badge with animation
                    currentStatusBadge.textContent = data.status_display;
                    currentStatusBadge.className = `badge fs-6 px-3 py-2 ${
                        newStatus === 'pending' ? 'bg-warning' :
                        newStatus === 'reviewed' ? 'bg-info' :
                        newStatus === 'accepted' ? 'bg-success' : 'bg-danger'
                    }`;
                    
                    // Add pulse animation
                    currentStatusBadge.style.animation = 'pulse 0.6s ease';
                    setTimeout(() => {
                        currentStatusBadge.style.animation = '';
                    }, 600);
                    
                    // Show success message
                    showStatusMessage('success', `${data.message} (Now: <strong>${data.status_display}</strong>)`);
                } else {
                    this.innerHTML = originalContent;
                    this.disabled = false;
                    showStatusMessage('error', data.error || 'Failed to update status');
                }
            })
            .catch(error => {
                this.innerHTML = originalContent;
                this.disabled = false;
                showStatusMessage('error', `Network error: ${error}`);
            });
        });
    });

    function showStatusMessage(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle';
        
        statusMessage.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show rounded-3 border-0 shadow-sm" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi ${icon} me-2 fs-5"></i>
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>`;
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const alert = statusMessage.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
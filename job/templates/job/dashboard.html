{% extends "job/base.html" %}
{% load static %}
{% block title %} Dashboard {% endblock %}

{% block content %}
<style>
  .user-btn {
    background: var(--primary);
    color: #ffffff;
  }
  .user-btn:hover {
    background: var(--secondary);
    color: #ffffff;
  }

  .applicant-btn {
    border: 1px solid var(--primary);
    color: var(--primary);
  }
  .applicant-btn:hover {
    background: var(--primary);
    color: #ffffff;
  }
  
  .chart-container {
    position: relative;
    height: 350px;
    width: 100%;
  }
</style>

<div class="main-header">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="h3 mb-0">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
      <a href="{% url 'add_admin_user' %}" class="btn btn-sm user-btn">
        <i class="bi bi-person-fill-add me-1"></i>
        Add User
      </a>
    </div>
  </div>
</div>

<!-- Stats Cards (Keep exactly as you have them) -->
<div class="row">
  <div class="col-xl-4 col-md-6 mb-4">
    <div class="card border-0 stats-card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <div class="bg-soft-primary p-3 rounded-3">
              <i class="bi bi-briefcase-fill fs-3" style="color: #257dd4"></i>
            </div>
          </div>
          <div class="flex-shrink-0">
            <h4 class="mb-0">{{ total_jobs }}</h4>
          </div>
        </div>
        <div class="mt-1">
          <a href="{% url "job_list" %}" class="badge bg-soft-success h2 text-decoration-none" style="color: #257dd4">
            Jobs <i class="bi bi-chevron-right mx-2"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-4 col-md-6 mb-4">
    <div class="card border-0 stats-card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <div class="bg-soft-success p-3 rounded-3">
              <i class="bi bi-people-fill fs-3" style="color: #257dd4"></i>
            </div>
          </div>
          <div class="flex-shrink-0">
            <h4 class="mb-0">{{ total_applications }}</h4>
          </div>
        </div>
        <div class="mt-1">
          <a href="{% url "applicants_list" %}" class="badge bg-soft-success h3 text-decoration-none" style="color: #257dd4">
            Applicants <i class="bi bi-chevron-right mx-2"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-4 col-md-6 mb-4">
    <div class="card border-0 stats-card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-grow-1">
            <div class="bg-soft-info p-3 rounded-3">
              <i class="bi bi-person-check fs-3" style="color: #257dd4"></i>
            </div>
          </div>
          <div class="flex-shrink-0">
            <h4 class="mb-0">{{ total_admins }}</h4>
          </div>
        </div>
        <div class="mt-1">
          <a href="{% url 'admin_users_list' %}" class="badge bg-soft-success h3 text-decoration-none" style="color: #257dd4">
            Users <i class="bi bi-chevron-right mx-2"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart Section - col-lg-6 as requested -->
<div class="row">
  <div class="col-lg-7">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1 fw-bold text-dark">Most Applied Jobs</h5>
            <p class="text-muted mb-0">Top job positions by application volume</p>
          </div>
          <span class="badge bg-primary bg-opacity-10 text-primary fs-6">
            <i class="bi bi-trophy me-1"></i>Top {{ top_job_titles|length }}
          </span>
        </div>
      </div>
      <div class="card-body">
        {% if top_job_titles.0 != 'No applications yet' %}
          <div class="chart-container">
            <canvas id="topJobsChart"></canvas>
          </div>
        {% else %}
          <div class="text-center py-5">
            <div class="mb-3">
              <i class="bi bi-bar-chart-line fs-1 text-muted opacity-50"></i>
            </div>
            <h5 class="text-muted">No applications data yet</h5>
            <p class="text-muted">Application statistics will appear here once candidates start applying.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0">
        <h5 class="card-title mb-0 fw-bold text-dark">Recent Activity</h5>
      </div>
      <div class="card-body">
        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-marker bg-primary"></div>
            <div class="timeline-content">
              <h6 class="mb-1">Sarah Johnson applied for Frontend Developer</h6>
              <p class="text-muted mb-0 small">2 hours ago</p>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-marker bg-success"></div>
            <div class="timeline-content">
              <h6 class="mb-1">Michael Chen scheduled an interview</h6>
              <p class="text-muted mb-0 small">5 hours ago</p>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-marker bg-info"></div>
            <div class="timeline-content">
              <h6 class="mb-1">Emma Wilson was hired as UX Designer</h6>
              <p class="text-muted mb-0 small">Yesterday</p>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-marker bg-warning"></div>
            <div class="timeline-content">
              <h6 class="mb-1">David Brown posted a new job</h6>
              <p class="text-muted mb-0 small">2 days ago</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0">
        <h5 class="card-title mb-0 fw-bold text-dark">Recent Applicants</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="bg-light">
              <tr>
                <th scope="col" class="border-0 ps-4">Name</th>
                <th scope="col" class="border-0">Position</th>
                <th scope="col" class="border-0">Status</th>
                <th scope="col" class="border-0 pe-4">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for applicant in recent_applications %}
              <tr>
                <td class="ps-4">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                        <span class="text-primary small fw-bold">{{ applicant.applicant_name|first|upper }}</span>
                      </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <span class="fw-medium text-dark">{{ applicant.applicant_name }}</span>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="text-dark">{{ applicant.job.title|truncatewords:3 }}</span>
                </td>
                <td>
                  <span class="badge 
                      {% if applicant.status == 'pending' %} bg-warning
                      {% elif applicant.status == 'reviewed' %} bg-info
                      {% elif applicant.status == 'shortlisted' %} bg-primary
                      {% elif applicant.status == 'interview' %} bg-purple
                      {% elif applicant.status == 'accepted' %} bg-success
                      {% else %} bg-danger
                      {% endif %}">
                      {{ applicant.status|title }}
                  </span>
                </td>
                <td class="pe-4">
                  <a href="{% url 'applicant_detail' applicant.id %}" class="btn btn-sm applicant-btn">
                    <i class="bi bi-eye me-1"></i> View
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const topJobsCtx = document.getElementById('topJobsChart');
      if (topJobsCtx) {
          // Create gradient using your primary color
          const gradient = topJobsCtx.getContext('2d').createLinearGradient(0, 0, 0, 400);
          gradient.addColorStop(0, 'rgba(37, 125, 212, 0.8)');
          gradient.addColorStop(1, 'rgba(37, 125, 212, 0.2)');

          const topJobsChart = new Chart(topJobsCtx, {
              type: 'polarArea',
              data: {
                  labels: {{ top_job_titles|safe }},
                  datasets: [{
                      label: 'Applications',
                      data: {{ top_job_applications|safe }},
                      backgroundColor: gradient,
                      borderColor: 'rgba(37, 125, 212, 1)',
                      borderWidth: 2,
                      borderRadius: 8,
                      borderSkipped: false,
                      barPercentage: 0.6,
                      categoryPercentage: 0.7,
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  layout: {
                      padding: {
                          top: 10,
                          right: 15,
                          bottom: 10,
                          left: 10
                      }
                  },
                  plugins: {
                      legend: {
                          display: false
                      },
                      tooltip: {
                          backgroundColor: 'rgba(255, 255, 255, 0.95)',
                          titleColor: '#2c3e50',
                          bodyColor: '#2c3e50',
                          borderColor: 'rgba(37, 125, 212, 0.2)',
                          borderWidth: 1,
                          cornerRadius: 6,
                          displayColors: false,
                          padding: 10,
                          callbacks: {
                              title: function(tooltipItems) {
                                  return tooltipItems[0].label;
                              },
                          }
                      }
                  },
                  animation: {
                      duration: 1000,
                      easing: 'easeOutQuart'
                  }
              }
          });
      }
  });
</script>

<style>
  .timeline {
      position: relative;
      padding-left: 20px;
  }

  .timeline-item {
      position: relative;
      padding-bottom: 20px;
  }

  .timeline-item:last-child {
      padding-bottom: 0;
  }

  .timeline-marker {
      position: absolute;
      left: -20px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 0 2px var(--bs-primary);
  }

  .timeline-content {
      padding-left: 10px;
  }

  .bg-purple {
      background-color: #6f42c1 !important;
  }

  .card {
      border: 1px solid rgba(0, 0, 0, 0.08);
  }
</style>
{% endblock %}
{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %} Job #{{ job.title }}{% endblock %}

{% block extra_head %}
<!-- Add CSRF token meta tag for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block extra_css %}
<style>
    /* Navigation Styles */
    .navbar {
        padding: 15px 0;
        transition: all 0.3s ease;
        background: white !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        width: 100%;
        z-index: 1000;
    }
    
    .navbar-brand {
        font-weight: 700;
        font-size: 1.8rem;
        color: var(--primary);
        display: flex;
        align-items: center;
    }
    
    .navbar-brand .logo {
        height: 100px;
        margin-right: 10px;
    }
    
    .navbar-nav .nav-link {
        color: var(--dark);
        font-weight: 500;
        margin: 0 10px;
        transition: color 0.3s ease;
        position: relative;
    }
    
    .navbar-nav .nav-link::after {
        content: '';
        position: absolute;
        width: 0;
        height: 2px;
        bottom: 0;
        left: 0;
        background-color: var(--primary);
        transition: width 0.3s ease;
    }
    
    .navbar-nav .nav-link:hover::after,
    .navbar-nav .nav-link.active::after {
        width: 100%;
    }
    
    .navbar-nav .nav-link:hover,
    .navbar-nav .nav-link.active {
        color: var(--primary);
    }
    
    .btn-primary {
        background-color: var(--primary);
        border-color: var(--primary);
        padding: 12px 30px;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-outline-primary {
        border-color: var(--primary);
        color: var(--primary);
        padding: 10px 25px;
        transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary);
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Bookmark button styles */
    .bookmark-btn {
        transition: all 0.3s ease;
        border-width: 2px;
    }
    
    .bookmark-btn:hover {
        transform: translateY(-2px);
    }
    
    .bookmark-btn.bookmarked {
        background-color: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    
    .bookmark-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    /* Hero Section */
    .job-hero {
        background: linear-gradient(rgba(3, 19, 19, 0.9), rgba(3, 15, 15, 0.8)), url('https://images.unsplash.com/photo-1507679799987-c73779587ccf?ixlib=rb-4.0.3&auto=format&fit=crop&w=1500&q=80');
        background-size: cover;
        background-position: center;
        padding: 100px 0 60px;
        color: white;
    }
    
    .hero-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 20px;
    }
    
    .breadcrumb {
        background: transparent;
        margin-bottom: 0;
        padding: 0;
    }
    
    .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
    }
    
    .breadcrumb-item.active {
        color: white;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Job Details Section */
    .job-details-section {
        padding: 80px 0;
    }
    
    .job-header {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .job-header:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .company-logo {
        width: 80px;
        height: 80px;
        object-fit: contain;
        margin-right: 20px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: transform 0.3s ease;
    }
    
    .job-header:hover .company-logo {
        transform: scale(1.05);
    }
    
    .job-type {
        background: var(--light);
        color: var(--primary);
        padding: 5px 15px;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 500;
        display: inline-block;
        margin-bottom: 15px;
    }
    
    .job-title {
        font-weight: 700;
        margin-bottom: 5px;
        font-size: 1.8rem;
        color: var(--secondary);
    }

    .job-title:hover {
        color: var(--primary);
    }
    
    .company-name {
        color: var(--secondary);
        margin-bottom: 15px;
        display: block;
        font-size: 1.2rem;
    }
    
    .job-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .job-meta-item {
        display: flex;
        align-items: center;
        color: var(--secondary);
    }
    
    .job-meta-item i {
        margin-right: 8px;
        color: var(--primary);
        font-size: 1.1rem;
    }
    .job-currency i {
        margin-right: -2px;
    }
    
    .job-salary {
        color: var(--primary);
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .job-actions {
        display: flex;
        gap: 15px;
        margin-top: 25px;
    }
    
    /* Content Box */
    .content-box {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        transition: transform 0.3s ease;
    }
    
    .content-box:hover {
        transform: translateY(-3px);
    }
    
    .content-title {
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0;
        color: var(--dark);
        position: relative;
    }
    
    .content-title::after {
        content: '';
        position: absolute;
        width: 40px;
        height: 3px;
        background: var(--primary);
        bottom: 0;
        left: 0;
        border-radius: 3px;
    }
    
    /* Job Description */
    .job-description ul {
        padding-left: 20px;
        margin-bottom: 20px;
    }
    
    .job-description li {
        margin-bottom: 10px;
        position: relative;
    }
    
    .job-description li::before {
        content: 'â€¢';
        color: var(--primary);
        font-weight: bold;
        display: inline-block;
        width: 1em;
        margin-left: -1em;
    }
    
    /* Company Info */
    .company-info {
        text-align: center;
    }
    
    .company-info-logo {
        width: 100px;
        height: 100px;
        object-fit: contain;
        margin: 0 auto 20px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: transform 0.3s ease;
    }
    
    .company-info:hover .company-info-logo {
        transform: scale(1.05);
    }
    
    .company-social {
        margin-top: 20px;
    }
    
    .company-social a {
        color: var(--secondary);
        margin: 0 8px;
        font-size: 1.2rem;
        transition: color 0.3s ease, transform 0.3s ease;
    }
    
    .company-social a:hover {
        color: var(--primary);
        transform: translateY(-3px);
    }
    
    /* Application Form */
    .application-form .form-control {
        padding: 15px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .application-form .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.25rem rgba(0, 80, 83, 0.15);
    }
    
    .file-upload {
        border: 2px dashed #e2e8f0;
        border-radius: 6px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        cursor: pointer;
        transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    
    .file-upload:hover {
        border-color: var(--primary);
        background-color: rgba(0, 80, 83, 0.05);
    }
    
    .file-upload i {
        font-size: 2rem;
        color: var(--secondary);
        margin-bottom: 10px;
        transition: color 0.3s ease;
    }
    
    .file-upload:hover i {
        color: var(--primary);
    }
    
    /* Related Jobs */
    .related-jobs-section {
        background: var(--light);
        padding: 80px 0;
    }
    
    .section-title {
        margin-bottom: 50px;
        text-align: center;
        position: relative;
    }
    
    .section-title h2 {
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 15px;
    }
    
    .section-title p {
        color: var(--secondary);
        max-width: 600px;
        margin: 0 auto;
    }
    
    .section-title::after {
        content: '';
        position: absolute;
        width: 60px;
        height: 4px;
        background: var(--primary);
        bottom: -15px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 2px;
    }
    
    .related-job-card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-top: 3px solid transparent;
    }
    
    .related-job-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-top-color: var(--primary);
    }
    
    .related-job-type {
        background: var(--light);
        color: var(--primary);
        padding: 5px 15px;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 500;
        display: inline-block;
        margin-bottom: 15px;
    }
    
    .related-company-logo {
        width: 50px;
        height: 50px;
        object-fit: contain;
        margin-right: 15px;
        background: white;
        padding: 5px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: transform 0.3s ease;
    }
    
    .related-job-card:hover .related-company-logo {
        transform: scale(1.1);
    }
    
    .related-job-title {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1.1rem;
        color: var(--secondary);
    }
    
    .related-job-title:hover {
        color: var(--primary);
    }
    
    .related-company-name {
        color: var(--secondary);
        margin-bottom: 15px;
        display: block;
    }
    
    .related-job-details {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .related-job-detail {
        display: flex;
        align-items: center;
        color: var(--secondary);
        font-size: 0.9rem;
    }
    
    .related-job-detail i {
        margin-right: 5px;
        color: var(--primary);
    }
    
    .related-job-salary {
        color: var(--primary);
        font-weight: 600;
    }
    
    .related-job-salary i {
        margin-right: -2px;
    }
    
    /* Footer */
    footer {
        background: var(--dark);
        color: white;
        padding: 70px 0 30px;
    }
    
    .footer-title {
        font-weight: 600;
        margin-bottom: 25px;
        font-size: 1.2rem;
    }
    
    .footer-links {
        list-style: none;
        padding: 0;
    }
    
    .footer-links li {
        margin-bottom: 10px;
    }
    
    .footer-links a {
        color: #cbd5e1;
        text-decoration: none;
        transition: color 0.3s ease;
    }
    
    .footer-links a:hover {
        color: white;
    }
    
    .social-icons a {
        color: white;
        font-size: 1.2rem;
        margin-right: 15px;
        transition: color 0.3s ease, transform 0.3s ease;
    }
    
    .social-icons a:hover {
        color: var(--primary-light);
        transform: translateY(-3px);
    }
    
    .copyright {
        border-top: 1px solid #334155;
        padding-top: 20px;
        margin-top: 50px;
        color: #94a3b8;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 992px) {
        .hero-title {
            font-size: 2.2rem;
        }
        
        .job-actions {
            flex-direction: column;
        }
        
        .bookmark-actions {
            flex-direction: column;
            align-items: flex-start;
        }
    }
    
    @media (max-width: 768px) {
        .hero-title {
            font-size: 1.8rem;
        }
        
        .job-details-section, .related-jobs-section {
            padding: 60px 0;
        }
        
        .job-meta {
            flex-direction: column;
            gap: 10px;
        }
        
        .job-title {
            font-size: 1.5rem;
        }
        
        .navbar-brand .logo {
            height: 30px;
        }
    }

    /* Share button hover effects */
    .company-social .btn {
        transition: all 0.3s ease;
        border-width: 2px;
    }

    .company-social .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Platform-specific colors on hover */
    .btn-outline-secondary:hover .fa-facebook-f {
        color: #1877F2;
    }

    .btn-outline-secondary:hover .fa-twitter {
        color: #1DA1F2;
    }

    .btn-outline-secondary:hover .fa-linkedin-in {
        color: #0077B5;
    }

    .btn-outline-secondary:hover .fa-envelope {
        color: #EA4335;
    }

    .btn-outline-secondary:hover .fa-link {
        color: var(--primary);
    }
</style>
{% endblock extra_css %}

{% block content %}

    <!-- Hero Section -->
    <section class="job-hero">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <h1 class="hero-title">{{ job.title }}</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url "index" %}">Home</a></li>
                            <li class="breadcrumb-item"><a href="{% url "job_listings" %}">Job Listings </a></li>
                            <li class="breadcrumb-item active" aria-current="page">{{ job.title }}</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- Job Details Section -->
    <section class="job-details-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <!-- Job Header -->
                    <div class="job-header">
                        <div class="d-flex align-items-center">
                            <div>
                                <span class="job-type">{{ job.workplace_type }}</span>
                                <h2 class="job-title">{{ job.title }}</h2>
                                <div class="job-meta">
                                    <div class="job-meta-item">
                                        <i class="fas fa-map-marker-alt"></i> {{ job.location }}
                                    </div>
                                    <div class="job-meta-item job-currency">
                                        <span class="job-salary">Salary starting from <i class="bi bi-currency-pound"></i>{{ job.salary_start|intcomma }} per annum</span>
                                    </div>
                                </div>

                                {% if job.short_description %}
                                <p class="text-muted">{{ job.short_description }}</p>
                                {% else %}
                                <p class="text-muted">{{ job.description|safe|striptags|truncatewords:40 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Bookmark and Application Section -->
                        <div class="job-actions">
                            {% if user.is_authenticated %}
                                {% if user.is_job_seeker %}
                                    <div class="bookmark-actions">
                                        {% if has_applied %}
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Application Submitted!</strong> 
                                                You applied on {{ application.applied_at|date:"F j, Y" }}. 
                                                <a href="{% url 'application_detail' application.id %}" class="alert-link">View Application</a>
                                            </div>
                                        {% else %}
                                            <div class="d-flex gap-2">
                                                <a href="{% url 'apply_for_job' job.id %}" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-paper-plane me-2"></i>Apply Now
                                                </a>
                                                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#quickApplyModal">
                                                    <i class="fas fa-bolt me-2"></i>Quick Apply
                                                </button>
                                            </div>
                                        {% endif %}
                                        <!-- Bookmark Button -->
                                        <div class="bookmark-component" data-job-id="{{ job.id }}">
                                            <button type="button" 
                                                    class="btn bookmark-btn {% if is_saved %}btn-outline-danger btn-lg{% else %}btn-outline-primary{% endif %}"
                                                    onclick="toggleSaveJob({{ job.id }})"
                                                    title="{% if is_saved %}Remove Bookmarked Job{% else %}Bookmark this Job{% endif %}">
                                                <i class="{% if is_saved %}fas{% else %}far{% endif %} fa-bookmark me-1"></i>
                                                <span class="bookmark-text">{% if is_saved %}Saved{% else %}Save{% endif %}</span>
                                            </button>
                                        </div>
                                    </div>
                                {% elif user.is_employer %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-briefcase me-2"></i>
                                        <strong>Employer View:</strong> You are viewing this job as an employer.
                                        {% if job.employer == user %}
                                            <a href="{% url 'edit_job' job.id %}" class="alert-link ms-2">Edit Job</a>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-secondary">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Job applications are only available for Job Seekers.
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Please <a href="{% url 'accounts:login' %}?next={% url 'job_detail_frontend' job.id %}" class="alert-link">log in</a> 
                                    as a Job Seeker to apply for this position.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Job Description -->
                    <div class="content-box job-description">
                        <h3 class="content-title"><strong>Job Description:</strong></h3>
                        {{ job.description|safe }}
                    </div>

                    <!-- Requirements & Skills -->
                    {% if job.requirements %}
                    <div class="content-box">
                        <h3 class="content-title"><strong>Requirements & Skills:</strong></h3>
                        {{ job.requirements|safe }}
                    </div>
                    {% endif %}

                    <!-- Benefits -->
                    {% if job.benefits %}
                    <div class="content-box">
                        <h3 class="content-title"><strong>Benefits:</strong></h3>
                        {{ job.benefits|safe }}
                    </div>
                    {% endif %}
                </div>

                <div class="col-lg-4">
                    <!-- Job Overview -->
                    <div class="content-box">
                        <h3 class="content-title">Job Overview</h3>
                        <div class="job-meta">
                            <div class="job-meta-item">
                                <i class="far fa-calendar"></i> <strong>Date Posted: </strong>&nbsp; {{ hours_ago }} hours ago
                            </div>
                            <div class="job-meta-item">
                                <i class="fas fa-map-marker-alt"></i> <strong>Location: </strong>&nbsp; {{ job.location|truncatechars:25 }}
                            </div>
                            <div class="job-meta-item">
                                <i class="fas fa-tag"></i> <strong>Job Title: </strong>&nbsp; {{ job.title|truncatechars:25 }}
                            </div>
                            <div class="job-meta-item">
                                <i class="far fa-clock"></i> <strong>Hours: </strong>&nbsp; {{ job.workplace_type }}
                            </div>
                            {% if job.experience_level %}
                            <div class="job-meta-item">
                                <i class="fas fa-briefcase"></i> <strong>Experience: </strong> {{ job.experience_level }}
                            </div>
                            {% endif %}
                            {% if job.education_level %}
                            <div class="job-meta-item">
                                <i class="fas fa-graduation-cap"></i> <strong>Education:</strong> {{ job.education_level }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Share This Job - Enhanced Version -->
                    <div class="content-box">
                        <h3 class="content-title">Share This Job</h3>
                        <div class="company-social">
                            <!-- Facebook -->
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}&quote=Check out this job: {{ job.title|urlencode }} at Tech Recruitmen UK" 
                            target="_blank" 
                            class="btn btn-outline-secondary me-2 share-btn"
                            data-platform="facebook">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            
                            <!-- Twitter -->
                            <a href="https://twitter.com/intent/tweet?text={{ share_text|urlencode }}&url={{ request.build_absolute_uri|urlencode }}&hashtags=jobs,hiring,career" 
                            target="_blank" 
                            class="btn btn-outline-secondary me-2 share-btn"
                            data-platform="twitter">
                                <i class="fab fa-twitter"></i>
                            </a>
                            
                            <!-- LinkedIn -->
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}&title={{ job.title|urlencode }}&summary={{ job.short_description|default:job.description|striptags|truncatewords:20|urlencode }}" 
                            target="_blank" 
                            class="btn btn-outline-secondary me-2 share-btn"
                            data-platform="linkedin">
                                <i class="fab fa-linkedin-in"></i>
                            </a>
                            
                            <!-- Copy Link -->
                            <button onclick="copyJobLink()" 
                                    class="btn btn-outline-secondary"
                                    title="Copy link to clipboard">
                                <i class="fas fa-link"></i>
                            </button>
                        </div>
                        
                        <!-- Copy Link Feedback -->
                        <div id="copyFeedback" class="mt-2" style="display: none;">
                            <small class="text-success"><i class="fas fa-check-circle"></i> Link copied to clipboard!</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Related Jobs Section -->
    <section class="related-jobs-section">
        <div class="container">
            <div class="section-title">
                <h2>Related Jobs</h2>
                <p>Explore other opportunities that might interest you</p>
            </div>
            
            <div class="row">
                {% for related_job in related_jobs %}
                <div class="col-lg-6 mb-4">
                    <div class="related-job-card">
                        <span class="related-job-type">{{ related_job.workplace_type }}</span>
                        <div class="d-flex align-items-center mb-3">
                            <div>
                                <h4 class="related-job-title">{{ related_job.title }}</h4>
                                {% if related_job.company %}
                                <span class="related-company-name">{{ related_job.company.name }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="related-job-details">
                            <div class="related-job-detail">
                                <i class="fas fa-map-marker-alt"></i> {{ related_job.location }}
                            </div>
                            {% if related_job.salary_start %}
                            <div class="related-job-detail related-job-salary">
                                <i class="bi bi-currency-pound"></i>{{ related_job.salary_start|intcomma }}
                            </div>
                            {% endif %}
                        </div>
                        <a href="{% url 'job_detail_frontend' related_job.id %}" class="btn btn-outline-primary btn-sm">View Details</a>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <p class="text-center">No related jobs found.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Quick Apply Modal -->
    <div class="modal fade" id="quickApplyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Apply</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Apply with your profile information. You can upload your resume later.</p>
                    <button type="button" class="btn btn-primary w-100" onclick="quickApply({{ job.id }})">
                        Confirm Quick Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
        // File upload functionality
        document.querySelector('.file-upload')?.addEventListener('click', function() {
            document.getElementById('resume-upload').click();
        });
        
        document.getElementById('resume-upload')?.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                document.querySelector('.file-upload h5').textContent = 'File selected: ' + e.target.files[0].name;
            }
        });

        // CSRF Token utility function - IMPROVED VERSION
        function getCsrfToken() {
            // Method 1: Get from Django's hidden form field (most reliable)
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                return csrfInput.value;
            }
            
            // Method 2: Get from meta tag
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }
            
            // Method 3: Get from cookie
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            
            console.log('CSRF Token found:', cookieValue ? 'Yes' : 'No');
            return cookieValue;
        }

        // Bookmark functionality - SIMPLIFIED VERSION
        function toggleSaveJob(jobId) {
            console.log('Toggling save for job:', jobId);
            
            const csrfToken = getCsrfToken();
            console.log('CSRF Token:', csrfToken);
            
            if (!csrfToken) {
                showNotification('Security token missing. Please refresh the page and try again.', 'error');
                return;
            }

            // Create a form element to submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/job/${jobId}/toggle-save/`;
            
            // Add CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add to document and submit
            document.body.appendChild(form);
            form.submit();
        }

        // Alternative AJAX version if you prefer
        function toggleSaveJobAjax(jobId) {
            console.log('Toggling save for job (AJAX):', jobId);
            
            const csrfToken = getCsrfToken();
            console.log('CSRF Token:', csrfToken);
            
            if (!csrfToken) {
                showNotification('Security token missing. Please refresh the page and try again.', 'error');
                return;
            }

            // Use FormData approach
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', csrfToken);

            fetch(`/job/${jobId}/toggle-save/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (response.status === 403) {
                    throw new Error('CSRF verification failed. Please refresh the page.');
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    updateBookmarkUI(jobId, data.is_saved);
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error || 'Failed to update bookmark', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification(error.message || 'An error occurred. Please try again.', 'error');
            });
        }

        function updateBookmarkUI(jobId, isSaved) {
            const bookmarkBtn = document.querySelector(`.bookmark-component[data-job-id="${jobId}"] .bookmark-btn`);
            const bookmarkIcon = bookmarkBtn.querySelector('i');
            const bookmarkText = bookmarkBtn.querySelector('.bookmark-text');
            
            if (isSaved) {
                bookmarkBtn.classList.add('bookmarked');
                bookmarkBtn.classList.remove('btn-outline-primary');
                bookmarkBtn.classList.add('btn-outline-danger');
                bookmarkIcon.className = 'fas fa-bookmark me-1';
                bookmarkText.textContent = 'Saved';
                bookmarkBtn.setAttribute('title', 'Remove from Saved');
            } else {
                bookmarkBtn.classList.remove('bookmarked');
                bookmarkBtn.classList.remove('btn-outline-danger');
                bookmarkBtn.classList.add('btn-outline-primary');
                bookmarkIcon.className = 'far fa-bookmark me-1';
                bookmarkText.textContent = 'Save';
                bookmarkBtn.setAttribute('title', 'Save Job');
            }
        }

        function showNotification(message, type = 'info') {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.custom-notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type];
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show custom-notification position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function quickApply(jobId) {
            const csrfToken = getCsrfToken();
            
            if (!csrfToken) {
                showNotification('Security token missing. Please refresh the page.', 'error');
                return;
            }

            fetch(`/job/${jobId}/quick-apply/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred during quick apply.', 'error');
            });
        }

        // Debug function to check CSRF token
        function debugCsrfToken() {
            const token = getCsrfToken();
            console.log('CSRF Token Debug:', {
                token: token,
                length: token ? token.length : 0,
                fromInput: document.querySelector('[name=csrfmiddlewaretoken]')?.value,
                fromMeta: document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
            });
            return token;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Job detail page loaded with bookmark functionality');
            // Debug CSRF token on load
            debugCsrfToken();
        });

        // Copy job link to clipboard
        function copyJobLink() {
            const jobUrl = window.location.href;
            
            // Using the modern Clipboard API
            navigator.clipboard.writeText(jobUrl).then(function() {
                // Show success feedback
                const feedback = document.getElementById('copyFeedback');
                feedback.style.display = 'block';
                
                // Hide feedback after 3 seconds
                setTimeout(() => {
                    feedback.style.display = 'none';
                }, 3000);
                
            }).catch(function(err) {
                // Fallback for older browsers
                console.error('Failed to copy: ', err);
                
                // Create temporary input element for fallback
                const tempInput = document.createElement('input');
                tempInput.value = jobUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                // Show success feedback for fallback too
                const feedback = document.getElementById('copyFeedback');
                feedback.style.display = 'block';
                setTimeout(() => {
                    feedback.style.display = 'none';
                }, 3000);
            });
        }

        // Optional: Add click tracking for analytics
        document.addEventListener('DOMContentLoaded', function() {
            const shareButtons = document.querySelectorAll('.company-social a');
            shareButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const platform = this.title.replace('Share on ', '').replace('Share via ', '');
                    console.log(`Job shared via ${platform}: ${window.location.href}`);
                    // You can add Google Analytics or other tracking here
                });
            });
        });
    </script>
{% endblock extra_js %}